<div class="clientes-container">
  <div class="header">
    <h1 class="page-title">
      <svg class="title-icon" viewBox="0 0 24 24" fill="none">
        <circle cx="12" cy="8" r="4" stroke="currentColor" stroke-width="2"/>
        <path d="M6 21v-2a4 4 0 0 1 4-4h4a4 4 0 0 1 4 4v2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      </svg>
      Gestión de Clientes
    </h1>
    <button mat-raised-button class="add-button" (click)="toggleForm()">
      <svg class="btn-icon" viewBox="0 0 24 24" fill="none">
        @if (showForm) {
          <line x1="18" y1="6" x2="6" y2="18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <line x1="6" y1="6" x2="18" y2="18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        } @else {
          <line x1="12" y1="5" x2="12" y2="19" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <line x1="5" y1="12" x2="19" y2="12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        }
      </svg>
      {{ showForm ? 'Cancelar' : 'Registrar Cliente' }}
    </button>
  </div>

  @if (showForm) {
    <div class="form-card">
      <div class="form-header">
        <h2>
          Registrar Nuevo Cliente
        </h2>
      </div>
      <form [formGroup]="clienteForm" (ngSubmit)="onSubmit()">
        <div class="form-row">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Nombre Completo</mat-label>
            <input matInput formControlName="nombre" placeholder="Ej: Juan Pérez García">
            <span matPrefix class="input-icon">
              <svg viewBox="0 0 24 24" fill="none">
                <circle cx="12" cy="8" r="4" stroke="currentColor" stroke-width="2"/>
                <path d="M6 21v-2a4 4 0 0 1 4-4h4a4 4 0 0 1 4 4v2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
            </span>
            @if (clienteForm.get('nombre')?.hasError('required') && clienteForm.get('nombre')?.touched) {
              <mat-error>El nombre es requerido</mat-error>
            }
            @if (clienteForm.get('nombre')?.hasError('minlength')) {
              <mat-error>El nombre debe tener al menos 3 caracteres</mat-error>
            }
          </mat-form-field>
        </div>

        <div class="form-row">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Correo Electrónico</mat-label>
            <input matInput type="email" formControlName="email" placeholder="Ej: juan.perez@example.com">
            <span matPrefix class="input-icon">
              <svg viewBox="0 0 24 24" fill="none">
                <rect x="3" y="5" width="18" height="14" rx="2" stroke="currentColor" stroke-width="2"/>
                <path d="M3 7l9 6l9-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
            </span>
            @if (clienteForm.get('email')?.hasError('required') && clienteForm.get('email')?.touched) {
              <mat-error>El email es requerido</mat-error>
            }
            @if (clienteForm.get('email')?.hasError('email')) {
              <mat-error>Email inválido</mat-error>
            }
          </mat-form-field>
        </div>

        <div class="form-actions">
          <button mat-raised-button color="primary" type="submit" class="submit-btn" [disabled]="submitting">
            @if (submitting) {
              <mat-spinner diameter="20"></mat-spinner>
            } @else {
              <svg class="btn-icon" viewBox="0 0 24 24" fill="none">
                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" stroke="currentColor" stroke-width="2"/>
                <polyline points="17 21 17 13 7 13 7 21" stroke="currentColor" stroke-width="2"/>
                <polyline points="7 3 7 8 15 8" stroke="currentColor" stroke-width="2"/>
              </svg>
              Registrar cliente
            }
          </button>
          <button mat-button type="button" class="cancel-btn" (click)="toggleForm()" [disabled]="submitting">
            Cancelar
          </button>
        </div>
      </form>
    </div>
  }

  <!-- Historial de compras del cliente -->
  @if (showHistorial && historialCliente) {
    <div class="historial-card">
      <div class="historial-header">
        <h2>
          <svg class="header-icon" viewBox="0 0 24 24" fill="none">
            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
            <polyline points="12 6 12 12 16 14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
          Historial de Compras - {{ historialCliente.nombre }}
        </h2>
        <button mat-icon-button (click)="cerrarHistorial()" class="close-button">
          <svg viewBox="0 0 24 24" fill="none">
            <line x1="18" y1="6" x2="6" y2="18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <line x1="6" y1="6" x2="18" y2="18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
      </div>
      
      <div class="cliente-info">
        <div class="info-item">
          <svg class="info-icon" viewBox="0 0 24 24" fill="none">
            <rect x="3" y="5" width="18" height="14" rx="2" stroke="currentColor" stroke-width="2"/>
            <path d="M3 7l9 6l9-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
          <div>
            <span class="info-label">Email</span>
            <span class="info-value">{{ historialCliente.email }}</span>
          </div>
        </div>
        <div class="info-item">
          <svg class="info-icon" viewBox="0 0 24 24" fill="none">
            <circle cx="9" cy="21" r="1" stroke="currentColor" stroke-width="2"/>
            <circle cx="20" cy="21" r="1" stroke="currentColor" stroke-width="2"/>
            <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <div>
            <span class="info-label">Total Compras</span>
            <span class="info-value">{{ historialCliente.totalBilletesComprados }} billetes</span>
          </div>
        </div>
      </div>

      @if (loadingHistorial) {
        <div class="loading-container">
          <mat-spinner diameter="40"></mat-spinner>
        </div>
      } @else if (historialBilletes.length === 0) {
        <div class="empty-state-small">
          <svg class="empty-icon" viewBox="0 0 24 24" fill="none">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" stroke="currentColor" stroke-width="2"/>
            <polyline points="14 2 14 8 20 8" stroke="currentColor" stroke-width="2"/>
            <line x1="9" y1="15" x2="15" y2="15" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
          <p>Este cliente no ha comprado billetes aún</p>
        </div>
      } @else {
        <div class="billetes-list">
          @for (billete of historialBilletes; track billete.id) {
            <div class="billete-item">
              <div class="billete-icon-wrapper">
                <svg class="billete-icon" viewBox="0 0 24 24" fill="none">
                  <rect x="2" y="8" width="20" height="10" rx="2" stroke="currentColor" stroke-width="2"/>
                  <circle cx="7" cy="13" r="1.5" fill="currentColor"/>
                  <circle cx="17" cy="13" r="1.5" fill="currentColor"/>
                  <path d="M12 10v6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
              </div>
              <div class="billete-info">
                <h4>Billete #{{ billete.numero }}</h4>
                <div class="billete-details">
                  <span class="detail-item">
                    <svg viewBox="0 0 24 24" fill="none">
                      <rect x="3" y="4" width="18" height="18" rx="2" stroke="currentColor" stroke-width="2"/>
                      <path d="M3 10h18M8 3v4M16 3v4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                      <circle cx="12" cy="15" r="2" fill="currentColor"/>
                    </svg>
                    {{ billete.sorteoNombre }}
                  </span>
                  <span class="detail-item price">
                    <svg viewBox="0 0 24 24" fill="none">
                      <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    ${{ billete.precio | number:'1.0-0' }}
                  </span>
                  <span class="detail-item">
                    <svg viewBox="0 0 24 24" fill="none">
                      <rect x="3" y="4" width="18" height="18" rx="2" ry="2" stroke="currentColor" stroke-width="2"/>
                      <line x1="16" y1="2" x2="16" y2="6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                      <line x1="8" y1="2" x2="8" y2="6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                      <line x1="3" y1="10" x2="21" y2="10" stroke="currentColor" stroke-width="2"/>
                    </svg>
                    {{ billete.fechaVenta | date:'dd/MM/yyyy HH:mm' }}
                  </span>
                </div>
              </div>
            </div>
          }
        </div>
      }
    </div>
  }

  <!-- Tabla de clientes -->
  <div class="table-card">
    @if (loading) {
      <div class="loading-container">
        <mat-spinner></mat-spinner>
      </div>
    } @else if (clientes.length === 0) {
      <div class="empty-state">
        <svg class="empty-icon" viewBox="0 0 24 24" fill="none">
          <circle cx="12" cy="8" r="4" stroke="currentColor" stroke-width="2"/>
          <path d="M6 21v-2a4 4 0 0 1 4-4h4a4 4 0 0 1 4 4v2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <line x1="1" y1="1" x2="23" y2="23" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
        <p>No hay clientes registrados</p>
        <button mat-raised-button class="add-button" (click)="toggleForm()">
          <svg class="btn-icon" viewBox="0 0 24 24" fill="none">
            <line x1="12" y1="5" x2="12" y2="19" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <line x1="5" y1="12" x2="19" y2="12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
          Registrar Primer Cliente
        </button>
      </div>
    } @else {
      <div class="table-container">
        <table mat-table [dataSource]="clientes" class="clientes-table">
          <!-- Nombre Column -->
          <ng-container matColumnDef="nombre">
            <th mat-header-cell *matHeaderCellDef>Nombre</th>
            <td mat-cell *matCellDef="let cliente">
              <div class="cliente-info-cell">
                <svg class="cliente-icon" viewBox="0 0 24 24" fill="none">
                  <circle cx="12" cy="8" r="4" stroke="currentColor" stroke-width="2"/>
                  <path d="M6 21v-2a4 4 0 0 1 4-4h4a4 4 0 0 1 4 4v2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
                <strong>{{ cliente.nombre }}</strong>
              </div>
            </td>
          </ng-container>

          <!-- Email Column -->
          <ng-container matColumnDef="email">
            <th mat-header-cell *matHeaderCellDef>Email</th>
            <td mat-cell *matCellDef="let cliente">
              <div class="email-cell">
                <svg class="email-icon" viewBox="0 0 24 24" fill="none">
                  <rect x="3" y="5" width="18" height="14" rx="2" stroke="currentColor" stroke-width="2"/>
                  <path d="M3 7l9 6l9-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
                {{ cliente.email }}
              </div>
            </td>
          </ng-container>

          <!-- Fecha Registro Column -->
          <ng-container matColumnDef="fechaRegistro">
            <th mat-header-cell *matHeaderCellDef>Fecha Registro</th>
            <td mat-cell *matCellDef="let cliente">
              <div class="date-cell">
                <svg class="date-icon" viewBox="0 0 24 24" fill="none">
                  <rect x="3" y="4" width="18" height="18" rx="2" ry="2" stroke="currentColor" stroke-width="2"/>
                  <line x1="16" y1="2" x2="16" y2="6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                  <line x1="8" y1="2" x2="8" y2="6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                  <line x1="3" y1="10" x2="21" y2="10" stroke="currentColor" stroke-width="2"/>
                </svg>
                {{ cliente.fechaRegistro | date:'dd/MM/yyyy' }}
              </div>
            </td>
          </ng-container>

          <!-- Billetes Comprados Column -->
          <ng-container matColumnDef="totalBilletesComprados">
            <th mat-header-cell *matHeaderCellDef>Billetes Comprados</th>
            <td mat-cell *matCellDef="let cliente">
              <div class="billetes-cell">
                <svg class="compras-icon" viewBox="0 0 24 24" fill="none">
                  <circle cx="9" cy="21" r="1" stroke="currentColor" stroke-width="2"/>
                  <circle cx="20" cy="21" r="1" stroke="currentColor" stroke-width="2"/>
                  <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <span class="billetes-badge">{{ cliente.totalBilletesComprados }}</span>
              </div>
            </td>
          </ng-container>

          <!-- Acciones Column -->
          <ng-container matColumnDef="acciones">
            <th mat-header-cell *matHeaderCellDef>Acciones</th>
            <td mat-cell *matCellDef="let cliente">
              <button mat-icon-button class="action-button" (click)="verHistorial(cliente)" matTooltip="Ver historial de compras">
                <svg viewBox="0 0 24 24" fill="none">
                  <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                  <polyline points="12 6 12 12 16 14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
              </button>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
        </table>
      </div>
    }
  </div>
</div>