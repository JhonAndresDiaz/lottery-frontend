<div class="billetes-container">
  <div class="header">
    <h1 class="page-title">
      <svg class="title-icon" viewBox="0 0 24 24" fill="none">
        <rect x="2" y="8" width="20" height="10" rx="2" stroke="currentColor" stroke-width="2"/>
        <circle cx="7" cy="13" r="1.5" fill="currentColor"/>
        <circle cx="17" cy="13" r="1.5" fill="currentColor"/>
        <path d="M12 10v6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      </svg>
      Gestión de Billetes
    </h1>
  </div>

  <mat-tab-group class="custom-tabs" animationDuration="300ms">
    <mat-tab>
      <ng-template mat-tab-label>
        <svg class="tab-icon" viewBox="0 0 24 24" fill="none">
          <circle cx="9" cy="21" r="1" stroke="currentColor" stroke-width="2"/>
          <circle cx="20" cy="21" r="1" stroke="currentColor" stroke-width="2"/>
          <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        Vender Billete
      </ng-template>
      
      <div class="tab-content">
        <div class="step-card">
          <div class="step-header">
            <div class="step-number">1</div>
            <h2>
              <svg class="step-icon" viewBox="0 0 24 24" fill="none">
                <rect x="3" y="4" width="18" height="18" rx="2" stroke="currentColor" stroke-width="2"/>
                <path d="M3 10h18M8 3v4M16 3v4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                <circle cx="12" cy="15" r="2" fill="currentColor"/>
              </svg>
              Seleccione un Sorteo
            </h2>
          </div>
          <div class="step-content">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Sorteo</mat-label>
              <mat-select [(ngModel)]="sorteoSeleccionado" (selectionChange)="onSorteoChange()">
                @for (sorteo of sorteos; track sorteo.id) {
                  <mat-option [value]="sorteo.id">
                    {{ sorteo.nombre }} - {{ sorteo.fecha }} 
                    ({{ sorteo.billetesDisponibles }} disponibles)
                  </mat-option>
                }
              </mat-select>
            </mat-form-field>
          </div>
        </div>

        @if (sorteoSeleccionado) {
          <div class="step-card">
            <div class="step-header">
              <div class="step-number">2</div>
              <h2>
                <svg class="step-icon" viewBox="0 0 24 24" fill="none">
                  <rect x="2" y="8" width="20" height="10" rx="2" stroke="currentColor" stroke-width="2"/>
                  <circle cx="7" cy="13" r="1.5" fill="currentColor"/>
                  <circle cx="17" cy="13" r="1.5" fill="currentColor"/>
                  <path d="M12 10v6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
                Seleccione un Billete
              </h2>
            </div>
            <div class="step-content">
              @if (loading) {
                <div class="loading-container">
                  <mat-spinner diameter="40"></mat-spinner>
                </div>
              } @else if (billetesDisponibles.length === 0) {
                <div class="empty-state">
                  <svg class="empty-icon" viewBox="0 0 24 24" fill="none">
                    <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                    <line x1="12" y1="8" x2="12" y2="12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    <circle cx="12" cy="16" r="1" fill="currentColor"/>
                  </svg>
                  <p>No hay billetes disponibles para este sorteo</p>
                </div>
              } @else {
                <div class="billetes-grid">
                  @for (billete of billetesDisponibles; track billete.id) {
                    <div 
                      class="billete-card"
                      [class.selected]="billeteSeleccionado?.id === billete.id"
                      (click)="seleccionarBillete(billete)">
                      <svg class="check-icon" viewBox="0 0 24 24" fill="none">
                        <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="currentColor"/>
                        <path d="M8 12l3 3l5-5" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                      <div class="billete-numero">#{{ billete.numero }}</div>
                      <div class="billete-precio">${{ billete.precio | number:'1.0-0' }}</div>
                    </div>
                  }
                </div>
              }
            </div>
          </div>
        }

        @if (billeteSeleccionado) {
          <div class="step-card">
            <div class="step-header">
              <div class="step-number">3</div>
              <h2>
                <svg class="step-icon" viewBox="0 0 24 24" fill="none">
                  <circle cx="12" cy="8" r="4" stroke="currentColor" stroke-width="2"/>
                  <path d="M6 21v-2a4 4 0 0 1 4-4h4a4 4 0 0 1 4 4v2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
                Seleccione un Cliente
              </h2>
            </div>
            <div class="step-content">
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Cliente</mat-label>
                <mat-select [(ngModel)]="clienteSeleccionado">
                  @for (cliente of clientes; track cliente.id) {
                    <mat-option [value]="cliente.id">
                      {{ cliente.nombre }} - {{ cliente.email }}
                    </mat-option>
                  }
                </mat-select>
              </mat-form-field>
            </div>
          </div>
        }

        @if (billeteSeleccionado && clienteSeleccionado) {
          <div class="confirmation-card">
            <div class="confirmation-header">
              <svg class="confirmation-icon" viewBox="0 0 24 24" fill="none">
                <circle cx="9" cy="21" r="1" stroke="currentColor" stroke-width="2"/>
                <circle cx="20" cy="21" r="1" stroke="currentColor" stroke-width="2"/>
                <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              <h2>Confirmar Venta</h2>
            </div>
            <div class="resumen">
              <div class="resumen-item">
                <svg class="resumen-icon" viewBox="0 0 24 24" fill="none">
                  <rect x="3" y="4" width="18" height="18" rx="2" stroke="currentColor" stroke-width="2"/>
                  <path d="M3 10h18M8 3v4M16 3v4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
                <div class="resumen-info">
                  <span class="label">Sorteo</span>
                  <span class="value">{{ billeteSeleccionado.sorteoNombre }}</span>
                </div>
              </div>
              <div class="resumen-item">
                <svg class="resumen-icon" viewBox="0 0 24 24" fill="none">
                  <rect x="2" y="8" width="20" height="10" rx="2" stroke="currentColor" stroke-width="2"/>
                  <circle cx="7" cy="13" r="1.5" fill="currentColor"/>
                  <circle cx="17" cy="13" r="1.5" fill="currentColor"/>
                </svg>
                <div class="resumen-info">
                  <span class="label">Billete</span>
                  <span class="value">#{{ billeteSeleccionado.numero }}</span>
                </div>
              </div>
              <div class="resumen-item">
                <svg class="resumen-icon" viewBox="0 0 24 24" fill="none">
                  <circle cx="12" cy="8" r="4" stroke="currentColor" stroke-width="2"/>
                  <path d="M6 21v-2a4 4 0 0 1 4-4h4a4 4 0 0 1 4 4v2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
                <div class="resumen-info">
                  <span class="label">Cliente</span>
                  <span class="value">{{ nombreClienteSeleccionado }}</span>
                </div>
              </div>
              <div class="resumen-item total">
                <svg class="resumen-icon" viewBox="0 0 24 24" fill="none">
                  <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <div class="resumen-info">
                  <span class="label">Total a pagar</span>
                  <span class="value">${{ billeteSeleccionado.precio | number:'1.0-0' }}</span>
                </div>
              </div>
            </div>
            <div class="confirmation-actions">
              <button 
                mat-raised-button 
                class="confirm-btn" 
                (click)="confirmarVenta()"
                [disabled]="loading">
                @if (loading) {
                  <mat-spinner diameter="20"></mat-spinner>
                } @else {
                  <svg class="btn-icon" viewBox="0 0 24 24" fill="none">
                    <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" stroke="currentColor" stroke-width="2"/>
                    <polyline points="17 21 17 13 7 13 7 21" stroke="currentColor" stroke-width="2"/>
                    <polyline points="7 3 7 8 15 8" stroke="currentColor" stroke-width="2"/>
                  </svg>
                  Confirmar venta
                }
              </button>
              <button 
                mat-button 
                class="cancel-btn"
                (click)="cancelarVenta()"
                [disabled]="loading">
                Cancelar
              </button>
            </div>
          </div>
        }
      </div>
    </mat-tab>

    <mat-tab>
      <ng-template mat-tab-label>
        <svg class="tab-icon" viewBox="0 0 24 24" fill="none">
          <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
          <line x1="12" y1="8" x2="12" y2="16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <line x1="8" y1="12" x2="16" y2="12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
        Crear Billete
      </ng-template>
      
      <div class="tab-content">
        <div class="form-card">
          <div class="form-header">
            <h2>
              Crear Nuevo Billete
            </h2>
          </div>
          <form [formGroup]="billeteForm" (ngSubmit)="onSubmitCrear()">
            <div class="form-row">
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Sorteo</mat-label>
                <mat-select formControlName="sorteoId">
                  @for (sorteo of sorteos; track sorteo.id) {
                    <mat-option [value]="sorteo.id">
                      {{ sorteo.nombre }} - {{ sorteo.fecha }}
                    </mat-option>
                  }
                </mat-select>
                @if (billeteForm.get('sorteoId')?.hasError('required') && billeteForm.get('sorteoId')?.touched) {
                  <mat-error>El sorteo es requerido</mat-error>
                }
              </mat-form-field>
            </div>

            <div class="form-row">
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Número del Billete (4 dígitos)</mat-label>
                <input matInput formControlName="numero" placeholder="Ej: 0001" maxlength="4">
                <span matPrefix class="input-icon">
                  <svg viewBox="0 0 24 24" fill="none">
                    <rect x="2" y="8" width="20" height="10" rx="2" stroke="currentColor" stroke-width="2"/>
                    <circle cx="7" cy="13" r="1.5" fill="currentColor"/>
                    <circle cx="17" cy="13" r="1.5" fill="currentColor"/>
                  </svg>
                </span>
                @if (billeteForm.get('numero')?.hasError('required') && billeteForm.get('numero')?.touched) {
                  <mat-error>El número es requerido</mat-error>
                }
                @if (billeteForm.get('numero')?.hasError('pattern')) {
                  <mat-error>Debe ser un número de 4 dígitos</mat-error>
                }
              </mat-form-field>
            </div>

            <div class="form-row">
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Precio</mat-label>
                <input matInput type="number" formControlName="precio" placeholder="Ej: 10000">
                <span matPrefix class="input-icon">
                  <svg viewBox="0 0 24 24" fill="none">
                    <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </span>
                @if (billeteForm.get('precio')?.hasError('required') && billeteForm.get('precio')?.touched) {
                  <mat-error>El precio es requerido</mat-error>
                }
                @if (billeteForm.get('precio')?.hasError('min')) {
                  <mat-error>El precio debe ser mayor a 0</mat-error>
                }
              </mat-form-field>
            </div>

            <div class="form-actions">
              <button mat-raised-button class="submit-btn" type="submit" [disabled]="submitting">
                @if (submitting) {
                  <mat-spinner diameter="20"></mat-spinner>
                } @else {
                  <svg class="btn-icon" viewBox="0 0 24 24" fill="none">
                    <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" stroke="currentColor" stroke-width="2"/>
                    <polyline points="17 21 17 13 7 13 7 21" stroke="currentColor" stroke-width="2"/>
                    <polyline points="7 3 7 8 15 8" stroke="currentColor" stroke-width="2"/>
                  </svg>
                  Guardar
                }
              </button>
              <button mat-button type="button" class="cancel-btn" (click)="billeteForm.reset()" [disabled]="submitting">
                Limpiar
              </button>
            </div>
          </form>
        </div>
      </div>
    </mat-tab>
  </mat-tab-group>
</div>